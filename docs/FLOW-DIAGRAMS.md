# 飲食記錄系統 - 系統流程和數據流圖

## 1. 用戶認證流程圖

```
┌─────────────────────────────────────────────────────────────┐
│                     用戶操作                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  輸入郵箱和密碼 → 點擊登入按鈕                         │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP POST /users/login
                       ▼
┌──────────────────────────────────────────────────────────────┐
│                   Express 後端                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. 驗證郵箱格式                                     │   │
│  │  2. 查詢用戶資料庫                                   │   │
│  │  3. 驗證密碼 (bcryptjs)                             │   │
│  │  4. 生成 JWT Token                                  │   │
│  │  5. 返回 Token 和用戶資訊                            │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │ JSON Response {token, user}
                       ▼
┌──────────────────────────────────────────────────────────────┐
│                    React 前端                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. 接收 token                                       │   │
│  │  2. 儲存到 localStorage                             │   │
│  │  3. 更新 AuthContext                                │   │
│  │  4. 重定向到 Dashboard                              │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

## 2. 飲食記錄 CRUD 完整流程

### Create (新增記錄)

```
用戶選擇食物 → 輸入份量和用餐類型 → 點擊「記錄飲食」
         │
         ▼
┌─────────────────────────────────────┐
│  前端 RecordForm 元件               │
│  ├─ 驗證表單資料                    │
│  ├─ 計算總卡路里                    │
│  └─ 調用 API                        │
└─────────────────────────────────────┘
         │
         │ POST /api/records
         │ {foodId, quantity, mealType, recordedAt}
         ▼
┌─────────────────────────────────────┐
│  Express 後端                       │
│  ├─ 驗證 JWT Token                  │
│  ├─ 查詢食物資訊                    │
│  ├─ 驗證輸入資料                    │
│  ├─ 建立 Record 文件                │
│  └─ 保存到 MongoDB                  │
└─────────────────────────────────────┘
         │
         │ {_id, foodId, totalCalories, ...}
         ▼
┌─────────────────────────────────────┐
│  前端 RecordList 元件               │
│  ├─ 更新記錄列表                    │
│  ├─ 重新計算日期統計                │
│  └─ 顯示成功訊息                    │
└─────────────────────────────────────┘
```

### Read (查詢記錄)

```
用戶進入 Dashboard → 選擇日期
         │
         ▼
┌─────────────────────────────────────┐
│  前端發送查詢請求                   │
│  GET /api/records?startDate=...&endDate=...
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Express 後端                       │
│  ├─ 解析查詢參數                    │
│  ├─ 執行 MongoDB 查詢               │
│  ├─ 關聯食物資訊 (populate)         │
│  └─ 返回記錄列表                    │
└─────────────────────────────────────┘
         │
         │ Array of Records with Food Info
         ▼
┌─────────────────────────────────────┐
│  前端                               │
│  ├─ 按餐型分組顯示                  │
│  ├─ 計算每日總卡路里                │
│  └─ 呈現數據視圖                    │
└─────────────────────────────────────┘
```

### Update (編輯記錄)

```
用戶點擊編輯按鈕 → 修改份量/用餐類型 → 點擊保存
         │
         ▼
┌─────────────────────────────────────┐
│  前端                               │
│  ├─ 驗證修改的資料                  │
│  └─ 調用 PUT /api/records/:id       │
└─────────────────────────────────────┘
         │
         │ {quantity, mealType, ...}
         ▼
┌─────────────────────────────────────┐
│  Express 後端                       │
│  ├─ 驗證訪問權限                    │
│  ├─ 更新記錄                        │
│  ├─ 重新計算卡路里                  │
│  └─ 保存到 MongoDB                  │
└─────────────────────────────────────┘
         │
         │ Updated Record
         ▼
┌─────────────────────────────────────┐
│  前端                               │
│  ├─ 更新列表                        │
│  └─ 重新計算統計                    │
└─────────────────────────────────────┘
```

### Delete (刪除記錄)

```
用戶點擊刪除按鈕 → 確認刪除
         │
         ▼
┌─────────────────────────────────────┐
│  前端                               │
│  └─ DELETE /api/records/:id         │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Express 後端                       │
│  ├─ 驗證訪問權限                    │
│  ├─ 刪除 MongoDB 記錄               │
│  └─ 返回刪除確認                    │
└─────────────────────────────────────┘
         │
         │ Deletion Confirmation
         ▼
┌─────────────────────────────────────┐
│  前端                               │
│  ├─ 移除記錄                        │
│  └─ 更新統計資訊                    │
└─────────────────────────────────────┘
```

## 3. 食物搜尋流程

### 本地搜尋流程

```
用戶輸入食物名稱
        │
        ▼
┌──────────────────────────┐
│  前端 RecordForm 元件    │
│  ├─ 觸發搜尋             │
│  └─ 限流器處理           │
└──────────────────────────┘
        │
        │ GET /api/foods/search/name?name=...
        ▼
┌──────────────────────────┐
│  Express 後端            │
│  ├─ 執行正則搜尋         │
│  ├─ 查詢本地 MongoDB     │
│  └─ 返回前 20 個結果     │
└──────────────────────────┘
        │
        │ Array of Foods
        ▼
┌──────────────────────────┐
│  前端                    │
│  ├─ 顯示搜尋結果下拉菜單 │
│  └─ 允許用戶選擇         │
└──────────────────────────┘
```

### 條碼搜尋流程

```
用戶掃描或輸入條碼
        │
        ▼
┌──────────────────────────┐
│  前端提交條碼            │
│  GET /api/foods/search/barcode/:barcode
└──────────────────────────┘
        │
        ▼
┌──────────────────────────┐
│  Express 後端            │
│  ├─ 查詢本地資料庫       │
│  │   ├─ 如果存在 → 返回  │
│  │   └─ 如果不存在 → 繼續│
│  │                       │
│  ├─ 調用 Open Food       │
│  │   Facts API          │
│  ├─ 解析返回資料         │
│  ├─ 保存到本地資料庫     │
│  └─ 返回食物資訊         │
└──────────────────────────┘
        │
        │ Food Data
        ▼
┌──────────────────────────┐
│  前端                    │
│  ├─ 顯示找到的食物       │
│  ├─ 預填表單             │
│  └─ 允許用戶修改         │
└──────────────────────────┘
```

## 4. 統計計算流程

```
用戶選擇日期
        │
        ▼
┌──────────────────────────────────────┐
│  前端 RecordList 元件                │
│  └─ GET /api/records?startDate=...&endDate=...
└──────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────┐
│  Express 後端                        │
│  ├─ 查詢該日期範圍內的記錄           │
│  ├─ 使用 aggregation pipeline        │
│  ├─ 按餐型分組                       │
│  ├─ 計算總卡路里                     │
│  └─ 返回統計資料                     │
└──────────────────────────────────────┘
        │
        │ { totalCalories, mealBreakdown, records }
        ▼
┌──────────────────────────────────────┐
│  前端                                │
│  ├─ 顯示總卡路里卡片                 │
│  ├─ 顯示餐型分佈                     │
│  ├─ 按餐型分組顯示記錄               │
│  └─ 允許用戶互動                     │
└──────────────────────────────────────┘
```

## 5. 資料庫操作流程

```
┌──────────────────────────────────────────────────────────┐
│                    Mongoose ODM 層                       │
│                   (資料庫操作抽象)                        │
└──────────────────────────┬───────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Users      │    │    Foods     │    │   Records    │
│ 集合         │    │  集合        │    │  集合        │
│              │    │              │    │              │
│ ├─ _id       │    │ ├─ _id       │    │ ├─ _id       │
│ ├─ username  │    │ ├─ name      │    │ ├─ userId    │
│ ├─ email     │    │ ├─ calories  │    │ ├─ foodId    │
│ ├─ password  │    │ ├─ protein   │    │ ├─ quantity  │
│ └─ createdAt │    │ ├─ source    │    │ ├─ mealType  │
│              │    │ └─ createdAt │    │ ├─ totalCal  │
└──────────────┘    └──────────────┘    └──────────────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                    ┌──────▼──────┐
                    │  MongoDB    │
                    │  資料庫     │
                    └─────────────┘
```

## 6. 完整用戶操作流程 (使用案例)

```
新用戶來到應用
        │
        ▼
┌──────────────────────────────┐
│  1. 用戶註冊                  │
│     ├─ 填寫表單               │
│     ├─ 後端驗證和加密密碼     │
│     └─ 建立用戶帳戶           │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  2. 用戶登入                  │
│     ├─ 輸入郵箱和密碼         │
│     ├─ 後端驗證               │
│     └─ 返回 JWT Token         │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  3. 進入儀表板                │
│     ├─ 顯示今日記錄           │
│     └─ 初始化狀態管理         │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  4. 記錄飲食                  │
│     ├─ 搜尋食物               │
│     │   ├─ 本地搜尋           │
│     │   └─ 條碼掃描           │
│     ├─ 輸入份量               │
│     └─ 確認記錄               │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  5. 查看統計                  │
│     ├─ 每日總卡路里           │
│     ├─ 餐型分佈               │
│     └─ 歷史記錄               │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  6. 管理食物 (可選)           │
│     ├─ 新增自訂食物           │
│     ├─ 編輯食物資訊           │
│     └─ 刪除食物               │
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│  7. 編輯記錄                  │
│     ├─ 修改份量               │
│     ├─ 改變用餐時間           │
│     └─ 刪除記錄               │
└──────────────────────────────┘
```

## 7. 錯誤處理流程

```
API 請求發送
        │
        ▼
┌─────────────────────────────────────┐
│  Express 中間件                     │
│  ├─ 驗證 JWT Token                  │
│  │   ├─ Token 有效 → 繼續            │
│  │   └─ Token 無效 → 401 錯誤        │
│  │                                  │
│  ├─ 驗證輸入資料                    │
│  │   ├─ 資料有效 → 繼續             │
│  │   └─ 資料無效 → 400 錯誤         │
│  │                                  │
│  └─ 資料庫操作                      │
│      ├─ 成功 → 返回資料             │
│      └─ 失敗 → 500 錯誤             │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│  統一錯誤回應格式                   │
│  {                                  │
│    success: false,                  │
│    message: "錯誤訊息",             │
│    error: "詳細資訊",               │
│    timestamp: "2024-01-09T..."      │
│  }                                  │
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│  前端錯誤處理                       │
│  ├─ 顯示錯誤訊息                    │
│  ├─ 記錄日誌                        │
│  └─ 允許用戶重試                    │
└─────────────────────────────────────┘
```

## 系統架構總結

```
┌────────────────────────────────────────────────────────────────┐
│                        用戶層                                  │
│              (Web 瀏覽器 / 行動應用)                          │
└───────────────────────────┬─────────────────────────────────────┘
                            │ HTTP/REST
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    應用層 (React)                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Components   │  │ Pages        │  │ Services     │          │
│  ├─ Auth       │  ├─ Dashboard   │  └─ API Calls   │          │
│  ├─ RecordForm │  └─ ...         │                │          │
│  ├─ RecordList │              └──────────────────────┘          │
│  └─ ...        │  ┌──────────────┐                            │
│              └──┤ Context (State)│                            │
│                 ├─ AuthContext  │                            │
│                 └─ FoodContext  │                            │
│                 └──────────────────┘                         │
└───────────────────────────┬──────────────────────────────────────┘
                            │ HTTP/REST (CORS)
                            │
┌───────────────────────────▼──────────────────────────────────────┐
│                  API 層 (Express.js)                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ Routes → Controllers → Services → Models               │    │
│  │                                                        │    │
│  │ ├─ POST   /users/register                             │    │
│  │ ├─ POST   /users/login                                │    │
│  │ ├─ GET    /foods                                      │    │
│  │ ├─ POST   /foods                                      │    │
│  │ ├─ POST   /records                                    │    │
│  │ ├─ GET    /records                                    │    │
│  │ └─ ...                                                │    │
│  └────────────────────────────────────────────────────────┘    │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ 外部 API 集成                                          │    │
│  ├─ Open Food Facts (條碼查詢)                           │    │
│  └─ TFDA API (台灣食品資料)                              │    │
│  └────────────────────────────────────────────────────────┘    │
└───────────────────────────┬──────────────────────────────────────┘
                            │ Mongoose ODM
                            │
┌───────────────────────────▼──────────────────────────────────────┐
│                  資料層 (MongoDB)                                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐               │
│  │ Users      │  │ Foods      │  │ Records    │               │
│  │ Collection │  │ Collection │  │ Collection │               │
│  └────────────┘  └────────────┘  └────────────┘               │
│        │               │               │                       │
│        └───────────────┴───────────────┘                       │
│                       │                                        │
│              MongoDB 儲存和索引                                │
│                       │                                        │
│              [持久化資料存儲]                                   │
└───────────────────────────────────────────────────────────────┘
```

---

**流程設計原則**:
- ✅ 明確的責任分工 (前端、後端、資料庫)
- ✅ 統一的數據格式 (JSON)
- ✅ 一致的錯誤處理
- ✅ 安全的身份驗證
- ✅ 可擴展的架構

